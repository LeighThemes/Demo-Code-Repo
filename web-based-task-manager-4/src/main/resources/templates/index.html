<!-- index.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Task List</title>
    <!-- Your CSS imports here -->
</head>
<body>

<!-- Inline form to add a new task -->
<form id="taskForm">
    <input type="text" id="name" name="name" placeholder="Enter task name" required />
    <input type="text" id="description" name="description" placeholder="Enter task description" required />
    <input type="date" id="dueDate" name="dueDate" required />
    <button type="submit">Add New Task</button>
</form>

<!-- Container for displaying tasks 
<div id="tasksContainer">
    <div th:each="task : ${tasks}">
    	<span id="blue">Status:</span>
        <span th:text="${task.name}">Task name</span>
        : 
        <span th:text="${task.description}">Task description</span>
        - 
        <span th:text="${#dates.format(task.dueDate, 'yyyy-MM-dd')}">Due date</span>
        <!-- <span th:text="${task.isComplete ? 'Done' : 'Not Done'}">Status</span> -->
        <!-- This is correct for Thymeleaf processed server-side 
		<button th:onclick="'toggleTaskComplete(' + ${task.id} + ', this);'">Toggle Complete</button>
		
		<button th:attr="onclick='deleteTask(' + ${task.id} + ', this)'">Delete2</button>
    </div>
</div> -->

<div id="tasksContainer">
    <div th:each="task: ${tasks}" th:id="'task-' + ${task.id}">
        <span id="blue">Status:</span>
        <span th:text="${task.name}">Task name</span>: 
        <span th:text="${task.description}">Task description</span>
        - 
        <span th:text="${#dates.format(task.dueDate, 'yyyy-MM-dd')}">Due date</span>
        <button th:onclick="'toggleTaskComplete(' + ${task.id} + ', this);'">Mark as Done</button>
        <button th:onclick="'deleteTask(' + ${task.id} + ', this);'">Delete Task</button>
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('taskForm');
    form.onsubmit = function (e) {
        e.preventDefault();
        var name = document.getElementById('name').value;
        var description = document.getElementById('description').value;
        var dueDate = document.getElementById('dueDate').value;
        fetch('/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: name, description: description, dueDate: dueDate })
        })
        .then(response => response.json())
        .then(task => {
            var tasksContainer = document.getElementById('tasksContainer');
            tasksContainer.innerHTML += renderTask(task);
            form.reset();
        })
        .catch(error => console.error('Error:', error));
    };
});

function toggleTaskComplete(taskId, btn) {
    fetch('/tasks/' + taskId + '/complete', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(task => {
        var taskElement = btn.parentNode;
        taskElement.querySelector('span').textContent = task.isComplete ? 'Done:' : 'Not Done:';
        btn.textContent = task.isComplete ? 'Mark as Not Done' : 'Mark as Done';
    })
    .catch(error => console.error('Error:', error));
}



function renderTask2(task) {
	var dueDate = new Date(task.dueDate);
	
	// BUG WHERE THE DATE GOES BACK A DAY MIGHT BE HERE OR NOT HERE
    var formattedDate = dueDate.toISOString().split('T')[0]; // This will give you a date in the format "yyyy-mm-dd"
    
    return '<div>' +
    '<span>' + 'Status' + '</span>: ' +
           '<span>' + task.name + '</span>: ' +
           '<span>' + task.description + '</span> - ' +
           '<span>' + formattedDate  + '</span> ' +
           // '<span>' + (task.isComplete ? 'Done' : 'Not Done') + '</span> ' +
           // '<span>' + (task.isComplete) + '</span> ' +
           '<button onclick="toggleTaskComplete(' + task.id + ', this)">' +
           (task.isComplete ? 'Mark as Not Done' : 'Mark as Done') + '</button>' +
           '</div>';
           
    return '<div id="task-' + task.id + '">' +
    // ... other task details ...
    '<button onclick="deleteTask(' + task.id + ', this)">Delete</button>' +
    '</div>';
}

function renderTask(task) {
    // Format the date to YYYY-MM-DD
    var dueDate = new Date(task.dueDate).toISOString().split('T')[0];

    return '<div class="task-item" id="task-' + task.id + '">' +
    		'<span>' + 'Status' + '</span>: ' +
           '<span>' + task.name + '</span>: ' +
           '<span>' + task.description + '</span> - ' +
           '<span>' + dueDate + '</span> ' +
           //'<span>' + (task.isComplete ? 'Done' : 'Not Done') + '</span> ' +
           '<button onclick="toggleTaskComplete(' + task.id + ', this)">' +
           (task.isComplete ? 'Mark as Not Done' : 'Mark as Done') + '</button> ' +
           '<button onclick="deleteTask(' + task.id + ', this)">Delete Task</button>' +
           '</div>';
}

function deleteTask(taskId, btn) {
    fetch('/tasks/' + taskId, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Remove the task element from the UI
            var taskElement = document.getElementById('task-' + taskId);
            if (taskElement) {
                taskElement.remove();
            }
        } else {
            console.error('Task could not be deleted.');
        }
    })
    .catch(error => console.error('Error:', error));
}

</script>

</body>
</html>
